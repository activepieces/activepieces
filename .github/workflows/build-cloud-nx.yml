name: CI
on:
  pull_request:

permissions:
  actions: read
  contents: read


jobs:
  main:
    runs-on: ubuntu-latest
    if: github.repository == 'activepieces/activepieces'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Turbo Cache
        uses: rharkor/caching-for-turbo@v2.2.1
        with:
          provider: s3
          s3-bucket: ${{ secrets.TURBO_CACHE_S3_BUCKET }}
          s3-region: auto
          s3-endpoint: ${{ secrets.TURBO_CACHE_S3_ENDPOINT }}
          s3-access-key-id: ${{ secrets.TURBO_CACHE_S3_ACCESS_KEY_ID }}
          s3-secret-access-key: ${{ secrets.TURBO_CACHE_S3_SECRET_ACCESS_KEY }}
          max-age: 3w
          max-size: 20gb

      - name: Get changed files
        id: changed-files
        run: echo "files=$(git diff --name-only HEAD origin/main | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Check if framework or common pieces are changed
        id: check-framework-common
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.files }}"
          if echo "$CHANGED_FILES" | grep -q "pieces/framework\|pieces/common"; then
            echo "framework_or_common_changed=true" >> $GITHUB_OUTPUT
          else
            echo "framework_or_common_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract pieces package names from changed files
        id: extract-pieces
        run: |
          PIECES=$(echo "${{ steps.changed-files.outputs.files }}" | grep -oE "packages/pieces/(community|core)/[^/]+" | awk -F'/' '{print $NF}' | sort -u | tr '\n' ',' | sed 's/,$//')
          if [ -n "$PIECES" ]; then
            FILTERS=$(echo "$PIECES" | tr ',' '\n' | sed 's/.*/{&}/' | tr '\n' ',' | sed 's/,$//')
            echo "pieces_filters=$FILTERS" >> $GITHUB_OUTPUT
          else
            echo "pieces_filters=" >> $GITHUB_OUTPUT
          fi

      - name: Lint core projects
        run: npx turbo run lint --filter=@activepieces/shared --filter=@activepieces/engine --filter=api --filter=web --filter=@activepieces/server-common --filter=worker --filter=ee-embed-sdk


      - name: Lint all pieces projects
        if: steps.check-framework-common.outputs.framework_or_common_changed == 'true'
        run: npx turbo run lint --filter='@activepieces/piece-*'

      - name: Build core projects
        run: npx turbo run build --filter=web --filter=api --filter=@activepieces/engine --filter=@activepieces/piece-http --filter=@activepieces/piece-data-mapper --filter=@activepieces/piece-approval --filter=@activepieces/piece-webhook

      - name: Build changed pieces projects
        if: steps.extract-pieces.outputs.pieces_filters != '' && steps.check-framework-common.outputs.framework_or_common_changed == 'false'
        run: |
          IFS=',' read -ra PIECES <<< "${{ steps.extract-pieces.outputs.pieces_filters }}"
          FILTER_ARGS=""
          for piece in "${PIECES[@]}"; do
            piece_name=$(echo "$piece" | tr -d '{}')
            if [ -f "packages/pieces/community/${piece_name}/package.json" ] || [ -f "packages/pieces/core/${piece_name}/package.json" ]; then
              FILTER_ARGS="$FILTER_ARGS --filter=@activepieces/piece-${piece_name}"
            fi
          done
          if [ -n "$FILTER_ARGS" ]; then
            npx turbo run build $FILTER_ARGS
          fi

      - name: Build all pieces projects
        if: steps.check-framework-common.outputs.framework_or_common_changed == 'true'
        run: npx turbo run build --filter='@activepieces/piece-*'

      - name: Run all tests and migration check in parallel
        run: |
          set -euo pipefail
          pids=()

          npx turbo run test --filter=@activepieces/engine --filter=@activepieces/shared &
          pids+=($!)

          npx turbo run test-ce --filter=api &
          pids+=($!)

          npx turbo run test-ee --filter=api &
          pids+=($!)

          npx turbo run test-cloud --filter=api &
          pids+=($!)

          npx turbo run check-migrations --filter=api &
          pids+=($!)

          status=0
          for pid in "${pids[@]}"; do
            if ! wait "$pid"; then
              status=1
            fi
          done
          exit $status
