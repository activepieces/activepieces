name: CI
on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  main:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.repository == 'activepieces/activepieces'
    
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'bun'
          
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - uses: nrwl/nx-set-shas@v4
      
      - run: bun install
      
      - name: Determine changed scope
        id: scope
        run: |
          CHANGED=$(git diff --name-only $NX_BASE..$NX_HEAD)
          
          if echo "$CHANGED" | grep -q "community/framework\|community/common"; then
            echo "lint_scope=pieces-*" >> $GITHUB_OUTPUT
            echo "build_scope=pieces-*" >> $GITHUB_OUTPUT
          else
            PIECES=$(echo "$CHANGED" | grep -oP "packages/pieces/[^/]+/[^/]+" | \
              awk -F'/' '{print "pieces-" $4}' | sort -u | paste -sd "," -)
            echo "lint_scope=${PIECES:-none}" >> $GITHUB_OUTPUT
            echo "build_scope=${PIECES:-none}" >> $GITHUB_OUTPUT
          fi
      
      - name: Lint
        run: |
          npx nx affected --target=lint --exclude="pieces-*"
          if [ "${{ steps.scope.outputs.lint_scope }}" != "none" ]; then
            npx nx run-many --target=lint --projects="${{ steps.scope.outputs.lint_scope }}"
          fi
      
      - name: Build
        run: |
          npx nx affected --target=build -c production --exclude="pieces-*"
          if [ "${{ steps.scope.outputs.build_scope }}" != "none" ]; then
            npx nx run-many --target=build -c production --projects="${{ steps.scope.outputs.build_scope }}"
          fi
      
      - name: Test
        run: |
          npx nx run-many --target=test --projects=engine,shared &
          npx nx run server-api:test-ce &
          npx nx run server-api:test-ee &
          npx nx run server-api:test-cloud &
          npx nx run server-api:check-migrations &
          wait