name: CI

on:
  pull_request:

permissions:
  actions: read
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

jobs:
  main:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.repository == 'activepieces/activepieces'

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Setup Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # Cache Bun dependencies
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            bun-${{ runner.os }}-

      # Cache Nx computation
      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: nx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-

      # Install dependencies
      - name: Install dependencies
        run: bun install

      # Configure SHAs for Nx affected
      - name: Set Nx SHAs
        uses: nrwl/nx-set-shas@v4

      # Show affected projects (debug visibility)
      - name: List affected projects
        run: npx nx print-affected --select=projects

      ########################################
      # LINT
      ########################################
      - name: Lint affected projects
        run: |
          npx nx affected \
            --target=lint \
            --parallel

      ########################################
      # BUILD
      ########################################
      - name: Build affected projects
        run: |
          npx nx affected \
            --target=build \
            -c production \
            --parallel

      ########################################
      # TEST ENGINE + SHARED
      ########################################
      - name: Run engine + shared tests
        run: |
          npx nx run-many \
            --target=test \
            --projects=engine,shared \
            --parallel

      ########################################
      # TEST SERVER API + MIGRATIONS
      ########################################
      - name: Run server-api tests + migration check
        run: |
          npx nx run-many \
            --projects=server-api \
            --targets=test-ce,test-ee,test-cloud,check-migrations \
            --parallel
